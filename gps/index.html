
<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<title>Mesurador de dist√†ncies avan√ßat</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 5px 10px; text-align: center; }
  input, button { padding: 6px; font-size: 14px; margin: 2px; }
  #estat { margin-top: 10px; font-style: italic; color: #555; }
  #map { height: 300px; margin-top: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h2>Mesurador de Latitud i Longitud Avan√ßat</h2>

<label><b>Indica el lloc:</b></label>
<input id="ubicacioInput" type="text" placeholder="Ex: Punt A">
<button onclick="mesura()">Mesura</button>
<button onclick="exportCSV()">Exporta CSV</button>
<button onclick="exportGPX()">Exporta GPX</button>
<div id="estat"></div>

<table id="mesuresTable">
  <!-- La l√≠nia 23 √©s l'inici d'una taula, per√≤ li hem de posar una id, per qu√©? Podr√≠a ser per molts motius. Primer, amb un #mesuresTable {propietat1:valor1} podr√≠a modificar per exemple
  els marges de la taula.
  Primer hauriem d'agafar la id amb un #mesuresTable{color:blue;margin:20px;}
  A m√©s a m√©s de poder canviar l'estil de la taula amb un identificador a la l√≠nia 88, gr√†cies a getElementById, agafo l'identificador(mesuresTable) que abans no feia res, i el transformo
  en una variable de tipus javascript constant perqu√® aix√≠ aconseguim poder modificar-la i afegir una-->
  <tr>
    <th>#</th>
    <th>Latitud</th>
    <th>Longitud</th>
    <th>Ubicaci√≥</th>
  </tr>
</table>

<h3>Dist√†ncies pas a pas</h3>
<div id="distancies"></div>
<!--A la l√≠nia 43, tinc un div que √©s un √†rea identificada amb una id, per√≤ no visible per defecte per l'usuari, la puc fer visible amb codi javascript o css o una combinaci√≥ que 
  canvii la propietat visible a hidden o a la inversa-->
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let mesures = [];
  <!--La l√≠nia 50 √©s un array. Els [] sempre indiquen arrays o conjunts de dades. Ara l'array es buit, per√≤ es important definir-ho buit perqu√® es reservi un espai a la memoria del ordinador
    per emmagatzemar diverses dades-->
let map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);
let polyline = L.polyline([], {color:'red'}).addTo(map);

function mesura() {
  /*La funci√≥ mesura el primer que fa √©s una estructura condicional amb un if, que t√© un signe d'admiraci√≥ !(significa negaci√≥).
  if (!navigator.geolocation). El if √©s el condicional que comprova que el objecte navigator de la classe navigator t√© un m√©tode anomenat geolocation est√† disponible en aquell navegador o no.
  El punt entre navigator i geolocation √©s molt important, perqu√® √©s la sintaxi del punt o dot syntax, √©s a dir el unt separa l'objecte del m√©tode que volem aplicar en aquest. El punt aplica l'acci√≥.
  Si el navegador no pot executar geolocation, haur√† de alertar mitjan√ßant un missatge.
  El return el que fa √©s mostrar el missatge en pantalla.
  Alert √©s una funci√≥ de javascript que mostra una finestra emergent amb un missatge per a l'usuari, √©s una funci√≥ molt senzilla perqu√® nom√©s t√© un argument. Els arguments √©s el que tenim
  a dins dels par√©ntesis, si no tenim arguments tenim els par√©ntesis buits. L'√∫nic argument √©s el text que volem mostrar a l'usuari. La finestreta emergent obliga a l'usuari a tancar-la.
  S'utilitza per a missatges simples com avisos, errors, confirmacions... Hi han altres tipus de finestres emergents m√©s modernes i potents que s'anomenen modals o finestres emergents modals.
  Si hi ha geolocalitzaci√≥ no surt la finestra, i s'executen la l√≠nia 77 i seguents.
  Navigation. geolocation √©s una API(interf√≠cie de programaci√≥ d'aplicacions) que ens dona la posici√≥ latitud i longitud de l'usuari. Aquesta aplicaci√≥ t√© una funci√≥ principal que √©s
  getCurrentPosition que significa obtenir la posici√≥ actual. T√© 3 arguments el primer argument es diu success/√©xit, el segon √©s error, i el tercer √©s options. Llavors la funci√≥ √©s
  getCurrentPosition(success,error,position). El primer argument succes √©s un callback, √©s un sistema que es crida i que permet obtenir la posici√≥ i ho fem amb la funci√≥ => (fletxa) que
  √©s una forma molt r√†pida d'escriure function tenen una sint√†xi simplificada i no utilitza la paraula this per referir-se a elles mateixes i ocupen menys espai.*/
  const estat = document.getElementById("estat");
  estat.textContent = "üîç Obtenint GPS amb precisi√≥ alta...";

  if (!navigator.geolocation) {
    alert("La geolocalitzaci√≥ no √©s compatible amb aquest navegador.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const ubicacio = document.getElementById("ubicacioInput").value || `Punt ${mesures.length+1}`;
      mesures.push({lat, lon, ubicacio});
      document.getElementById("ubicacioInput").value = "";
      estat.textContent = "‚úÖ Mesura registrada!";
      actualitzaTaula();
      calculaDistancies();
      actualitzaMapa();
    },
    (err) => {
      estat.textContent = "‚ö†Ô∏è Error GPS: " + err.message;
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

function actualitzaTaula() {
  const table = document.getElementById("mesuresTable");
  table.innerHTML = `
    <tr>
      <th>#</th>
      <th>Latitud</th>
      <th>Longitud</th>
      <th>Ubicaci√≥</th>
    </tr>`;

  mesures.forEach((m, i) => {
    const row = table.insertRow();
    row.insertCell(0).textContent = i+1;
    row.insertCell(1).textContent = m.lat.toFixed(6);
    row.insertCell(2).textContent = m.lon.toFixed(6);
    const cellUbic = row.insertCell(3);
    const input = document.createElement("input");
    input.value = m.ubicacio;
    input.oninput = () => {
      mesures[i].ubicacio = input.value;
      calculaDistancies();
      actualitzaMapa();
    };
    cellUbic.appendChild(input);
  });
}

function calculaDistancies() {
  const div = document.getElementById("distancies");
  if (mesures.length < 2) {
    div.innerHTML = "Afegiu almenys dues mesures per calcular dist√†ncies.";
    return;
  }

  let html = "";
  let totalPitag = 0;
  let totalHav = 0;
  for (let i = 0; i < mesures.length - 1; i++) {
    const p1 = mesures[i];
    const p2 = mesures[i+1];

    const dx = (p2.lon - p1.lon) * Math.cos((p1.lat + p2.lat)/2 * Math.PI/180) * 111.32;
    const dy = (p2.lat - p1.lat) * 110.574;
    const distPitag = Math.sqrt(dx*dx + dy*dy);
    totalPitag += distPitag;

    const R = 6371;
    const dLat = (p2.lat - p1.lat) * Math.PI/180;
    const dLon = (p2.lon - p1.lon) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distHav = R * c;
    totalHav += distHav;

    html += `<p><b>${i+1} ‚Üí ${i+2}:</b> ${p1.ubicacio} ‚Üí ${p2.ubicacio}<br>
      Pit√†gores: ${distPitag.toFixed(3)} km<br>
      Haversine: ${distHav.toFixed(3)} km</p>`;
  }

  html += `<p><b>Total:</b> Pit√†gores: ${totalPitag.toFixed(3)} km, Haversine: ${totalHav.toFixed(3)} km</p>`;
  div.innerHTML = html;
}

function actualitzaMapa() {
  const coords = mesures.map(m => [m.lat, m.lon]);
  polyline.setLatLngs(coords);
  if (coords.length > 0) map.setView(coords[coords.length-1], 15);
}

function exportCSV() {
  if (mesures.length === 0) return alert("No hi ha mesures per exportar.");
  let csv = "Latitud,Longitud,Ubicaci√≥\n";
  mesures.forEach(m => csv += `${m.lat},${m.lon},${m.ubicacio}\n`);
  const blob = new Blob([csv], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mesures.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function exportGPX() {
  if (mesures.length === 0) return alert("No hi ha mesures per exportar.");
  let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Mesurador">
<trk><name>Ruta GPS</name><trkseg>\n`;
  mesures.forEach(m => {
    gpx += `<trkpt lat="${m.lat}" lon="${m.lon}"><name>${m.ubicacio}</name></trkpt>\n`;
  });
  gpx += "</trkseg></trk></gpx>";
  const blob = new Blob([gpx], {type: "application/gpx+xml"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ruta.gpx";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
